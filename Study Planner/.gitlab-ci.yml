stages:
  - build
  - test
  - quality
  - package
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
  DOCKER_HUB_IMAGE: study-planner

# Cache Maven dependencies
cache:
  paths:
    - .m2/repository/

# Build stage
build:
  stage: build
  image: maven:3.9-eclipse-temurin-21
  script:
    - mvn clean compile -DskipTests
  artifacts:
    paths:
      - target/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop

# Unit tests
unit-tests:
  stage: test
  image: maven:3.9-eclipse-temurin-21
  services:
    - mongo:7.0
  variables:
    SPRING_DATA_MONGODB_URI: "mongodb://mongo:27017/testdb"
  script:
    - mvn test -Dtest=**/*Test
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      junit: target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# Integration tests
integration-tests:
  stage: test
  image: maven:3.9-eclipse-temurin-21
  services:
    - mongo:7.0
  variables:
    SPRING_DATA_MONGODB_URI: "mongodb://mongo:27017/testdb"
  script:
    - mvn test -Dtest=**/*RepositoryTest
  artifacts:
    reports:
      junit: target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# Code quality with SonarQube (bonus)
sonarqube-check:
  stage: quality
  image: maven:3.9-eclipse-temurin-21
  services:
    - mongo:7.0
  variables:
    SPRING_DATA_MONGODB_URI: "mongodb://mongo:27017/testdb"
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - |
      if [ -n "$SONARQUBE_URL" ] && [ -n "$SONARQUBE_TOKEN" ]; then
        mvn clean verify sonar:sonar \
          -Dsonar.projectKey=$CI_PROJECT_PATH \
          -Dsonar.host.url=$SONARQUBE_URL \
          -Dsonar.login=$SONARQUBE_TOKEN \
          -Dsonar.java.binaries=target/classes \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
      else
        echo "SonarQube non configur√© - skip"
      fi
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Static code analysis with SpotBugs
spotbugs:
  stage: quality
  image: maven:3.9-eclipse-temurin-21
  script:
    - mvn clean compile spotbugs:check
  artifacts:
    reports:
      codequality: target/spotbugsXml.xml
    paths:
      - target/spotbugsXml.xml
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Build Docker image
docker-build:
  stage: package
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
  only:
    - merge_requests
    - main
    - develop

# Deploy to Docker Hub (only on main branch)
docker-hub-deploy:
  stage: deploy
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD
  script:
    - |
      docker build -t $DOCKER_HUB_IMAGE:latest .
      docker build -t $DOCKER_HUB_IMAGE:$CI_COMMIT_SHORT_SHA .
      docker push $DOCKER_HUB_IMAGE:latest
      docker push $DOCKER_HUB_IMAGE:$CI_COMMIT_SHORT_SHA
  only:
    - main
  when: on_success
